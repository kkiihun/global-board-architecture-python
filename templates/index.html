{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>ğŸ“‹ ê²Œì‹œíŒ ëª©ë¡</h2>
            {% if user %}
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#writeModal">
                    + ê¸€ì“°ê¸°
                </button>
            {% endif %}
        </div>

        {% for post in posts %}
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">{{ post.title }}</h5>
                <p class="card-text text-muted" style="white-space: pre-wrap;">{{ post.content }}</p>

                <div class="d-flex justify-content-between align-items-center mt-3">
                    <small class="text-secondary">ì‘ì„±ì ID: {{ post.owner_id }}</small>
                    
                    {% if user and user.id == post.owner_id %}
                        <div>
                            <button onclick="openEditModal('{{ post.id }}', '{{ post.title }}', `{{ post.content }}`)" 
                                    class="btn btn-sm btn-outline-primary me-1">ìˆ˜ì •</button>
                            
                            <button onclick="deletePost({{ post.id }})" 
                                    class="btn btn-sm btn-outline-danger">ì‚­ì œ</button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% else %}
            <div class="alert alert-info text-center">
                ì‘ì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!
            </div>
        {% endfor %}
    </div> </div> <div class="modal fade" id="writeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ìƒˆ ê¸€ ì‘ì„±</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="postTitle" class="form-control mb-2" placeholder="ì œëª©">
                <textarea id="postContent" class="form-control" rows="5" placeholder="ë‚´ìš©"></textarea>
            </div>
            <div class="modal-footer">
                <button onclick="savePost()" class="btn btn-primary">ì €ì¥</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ê¸€ ìˆ˜ì •í•˜ê¸°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editPostId">
                <input type="text" id="editTitle" class="form-control mb-2" placeholder="ì œëª©">
                <textarea id="editContent" class="form-control" rows="5" placeholder="ë‚´ìš©"></textarea>
            </div>
            <div class="modal-footer">
                <button onclick="updatePost()" class="btn btn-primary">ìˆ˜ì • ì™„ë£Œ</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- [ê¸€ì“°ê¸° ê¸°ëŠ¥] ---
    async function savePost() {
        const title = document.getElementById('postTitle').value;
        const content = document.getElementById('postContent').value;

        if(!title || !content) {
            alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        const res = await fetch('/posts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, content })
        });

        if (res.ok) {
            location.reload();
        } else {
            alert("ê¸€ì“°ê¸° ì‹¤íŒ¨ (ë¡œê·¸ì¸ í•„ìš”)");
        }
    }

    // --- [ì‚­ì œ ê¸°ëŠ¥] ---
    async function deletePost(postId) {
        if (!confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) return;
        
        const res = await fetch(`/posts/${postId}`, { method: 'DELETE' });
        if (res.ok) {
            location.reload();
        } else {
            alert("ì‚­ì œ ê¶Œí•œì´ ì—†ê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // --- [ìˆ˜ì • ê¸°ëŠ¥] ---
    function openEditModal(id, title, content) {
        // ê¸°ì¡´ ê¸€ ë‚´ìš©ì„ ëª¨ë‹¬ì°½ì— ì±„ì›Œë„£ê¸°
        document.getElementById('editPostId').value = id;
        document.getElementById('editTitle').value = title;
        document.getElementById('editContent').value = content;

        // ëª¨ë‹¬ì°½ ë„ìš°ê¸°
        var myModal = new bootstrap.Modal(document.getElementById('editModal'));
        myModal.show();
    }

    async function updatePost() {
        const id = document.getElementById('editPostId').value;
        const title = document.getElementById('editTitle').value;
        const content = document.getElementById('editContent').value;

        const res = await fetch(`/posts/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, content })
        });

        if (res.ok) {
            alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
            location.reload();
        } else {
            alert("ìˆ˜ì • ì‹¤íŒ¨ (ë³¸ì¸ ê¸€ì´ ì•„ë‹ˆê±°ë‚˜ ì˜¤ë¥˜)");
        }
    }
</script>
{% endblock %}